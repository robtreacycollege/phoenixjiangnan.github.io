<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="zookeeper,zookeeper persistent sequential id,create mode persistent sequential," />





  <link rel="alternate" href="/atom.xml" title="Bowen's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="I got the opportunity to learn how ZooKeeper&amp;#39;s PERSISTENT_SEQUENTIAL node works, how a PERSISTENT_SEQUENTIAL node is created, and how the persistent sequential id is generated recently in a ZooKee">
<meta property="og:type" content="article">
<meta property="og:title" content="How does ZooKeeper's persistent sequential id work">
<meta property="og:url" content="https://phoenixjiangnan.github.io/2016/07/07/distributed system/zookeeper/How-does-ZooKeeper-s-persistent-sequential-id-work/index.html">
<meta property="og:site_name" content="Bowen's blog">
<meta property="og:description" content="I got the opportunity to learn how ZooKeeper&amp;#39;s PERSISTENT_SEQUENTIAL node works, how a PERSISTENT_SEQUENTIAL node is created, and how the persistent sequential id is generated recently in a ZooKee">
<meta property="og:updated_time" content="2016-07-18T04:33:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How does ZooKeeper's persistent sequential id work">
<meta name="twitter:description" content="I got the opportunity to learn how ZooKeeper&amp;#39;s PERSISTENT_SEQUENTIAL node works, how a PERSISTENT_SEQUENTIAL node is created, and how the persistent sequential id is generated recently in a ZooKee">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="https://phoenixjiangnan.github.io/2016/07/07/distributed system/zookeeper/How-does-ZooKeeper-s-persistent-sequential-id-work/"/>

  <title> How does ZooKeeper's persistent sequential id work | Bowen's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Bowen's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">keep learning - learning notes and blogs</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="https://phoenixjiangnan.github.io/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://phoenixjiangnan.github.io/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="https://phoenixjiangnan.github.io/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="https://phoenixjiangnan.github.io/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                How does ZooKeeper's persistent sequential id work
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-07-07T23:53:06+08:00" content="2016-07-07">
              2016-07-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/distributed-system/" itemprop="url" rel="index">
                    <span itemprop="name">distributed system</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/distributed-system/zookeeper/" itemprop="url" rel="index">
                    <span itemprop="name">zookeeper</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/07/distributed system/zookeeper/How-does-ZooKeeper-s-persistent-sequential-id-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/07/distributed system/zookeeper/How-does-ZooKeeper-s-persistent-sequential-id-work/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>I got the opportunity to learn <code>how ZooKeeper&#39;s PERSISTENT_SEQUENTIAL node works</code>, <code>how a PERSISTENT_SEQUENTIAL node is created</code>, and <code>how the persistent sequential id is generated</code> recently in a ZooKeeper data migration project.</p>
<p>The project is about implementing our own logic to back and restore ZooKeeper’s data. There are several reasons why we are doing it ourselves rather than using ZooKeeper’s logs and snapshots, but it’s beyond the scope of this article.</p>
<p>The <code>PERSISTENT_SEQUENTIAL</code> node problem came up to the table in the following scenario. Let’s say you want to maintain <code>a list of strictly ordered tasks</code> in ZooKeeper, basically <code>using ZooKeeper as a task scheduling pool</code>. The best practice to do it is, having a parent node <code>/tasks</code> and creating new tasks as its children nodes with <code>CreateMode.PERSISTENT_SEQUENTIAL</code>, with names like <code>/tasks/task0000000001</code> and <code>/tasks/task0000000002</code>. How is the sequential id generated? ZooKeeper has an internally maintained counter.</p>
<p>The original general implementation for our own migration is to take a backup of all the <code>persistent</code> nodes and their data in old ZooKeeper (ZK0) and restore the data to the newly deployed ZooKeeper (ZK1) by recreating all those <code>persistent</code> nodes. That doesn’t work for <code>PERSISTENT_SEQUENTIAL</code> nodes because the internal counter for id does not get migrated. So when I trired to create new tasks in the ZK1 after migration, the sequential id generator tries to create the new task as <code>/tasks/task0000000001</code> and got a confliction of nodes with <code>KeeperException.NodeExistsException</code>.</p>
<p>So let’s talk about how <code>PERSISTENT_SEQUENTIAL</code> nodes works and how I solved this problem for our migration.</p>
<a id="more"></a>
<h1 id="The-Start"><a href="#The-Start" class="headerlink" title="The Start"></a>The Start</h1><p>The only source I found online is this <a href="https://stackoverflow.com/questions/10338076/zookeeper-persistent-sequential-incrementing-by-two/36927266#36927266" target="_blank" rel="external">stackoverflow</a> question.</p>
<blockquote>
<p>Creation or deletion of any child znode increments the cversion of the parent znode. Since in ZooKeeper <code>3.3.3</code>, the counter used for sequential znode creation is cversion itself, any “spurious” creation/deletion between two sequential creations is the most likely reason for the behavior you are experiencing.</p>
<p>Keep in mind that since <code>ZooKeeper 3.4.x</code>, deletions do not affect the parent sequence counter anymore: a <code>DataNode</code> internally holds a <code>StatPersisted</code> in which the <code>cversion</code> represents <code>the number of creations</code> exactly; on the contrary, the cversion of the Stat that you obtain by querying the node still represents the number of children changes: Stat.cversion = 2*PersistedStat.cversion - Stat.numChildren.</p>
</blockquote>
<p>(FYI, the original post says its <code>PersistedStat</code>, and I editted and corrected it as <code>StatPersisted</code>)</p>
<h1 id="The-Principle"><a href="#The-Principle" class="headerlink" title="The Principle"></a>The Principle</h1><p>On the server side, ZooKeeper (<code>ZooKeeperServer.java</code>) maintains a hashmap mapping each path to a <code>ChangeRecord</code> object, which consists of <code>StatPersisted</code>. <code>StatPersisted</code> is very similar to <code>Stat</code>, having all the version variables, especially <code>cversion</code>. </p>
<p>In <code>Stat</code>, <code>cversion</code> indicates <code>number of changes to the children of a znode</code>. So in normal usage, a node’s <code>cversion</code> will increase when its children are added and removed. But since 3.4.x, <code>StatPersisted</code>‘s <code>cversion</code> in <code>ChangeRecord</code> only increase when a child is added to the node.</p>
<p>So when a <code>PERSISTENT_SEQUENTIAL</code> node is added to ZooKeeper, ZooKeeper will look at its parent’s <code>ChangeRecord</code>‘s <code>cversion</code>, use it as sequential id, and then increment <code>cversion</code> by 1.</p>
<h1 id="Source-Code-Analysis"><a href="#Source-Code-Analysis" class="headerlink" title="Source Code Analysis"></a>Source Code Analysis</h1><h2 id="The-Client-ZooKeeper-java"><a href="#The-Client-ZooKeeper-java" class="headerlink" title="The Client - ZooKeeper.java"></a>The Client - <code>ZooKeeper.java</code></h2><p><a href="http://grepcode.com/file/repo1.maven.org/maven2/org.apache.zookeeper/zookeeper/3.4.6/org/apache/zookeeper/ZooKeeper.java#ZooKeeper" target="_blank" rel="external">org.apache.zookeeper.ZooKeeper.java</a> in 3.4.6. This client code sends a request to the server.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">An ephemeral node will be removed by the ZooKeeper automatically when the session associated with the creation of the node expires.</div><div class="line"></div><div class="line">The flags argument can also specify to create a sequential node. The actual path name of a sequential node will be the given path plus a suffix "i" where i is the current sequential number of the node. The sequence number is always fixed length of 10 digits, 0 padded. Once such a node is created, the sequential number will be incremented by one.</div><div class="line"></div><div class="line">If a node with the same actual path already exists in the ZooKeeper, a KeeperException with error code KeeperException.NodeExists will be thrown. Note that since a different actual path is used for each invocation of creating sequential node with the same path argument, the call will never throw "file exists" KeeperException.</div><div class="line"></div><div class="line">If the parent node does not exist in the ZooKeeper, a KeeperException with error code KeeperException.NoNode will be thrown.</div><div class="line"></div><div class="line">An ephemeral node cannot have children. If the parent node of the given path is ephemeral, a KeeperException with error code KeeperException.NoChildrenForEphemerals will be thrown.</div><div class="line"></div><div class="line">If a node is created successfully, the ZooKeeper server will trigger the watches on the path left by exists calls, and the watches on the parent of the node by getChildren calls.</div><div class="line"></div><div class="line">The maximum allowable size of the data array is 1 MB (1,048,576 bytes). Arrays larger than this will cause a KeeperExecption to be thrown.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl,</span></span></div><div class="line">        CreateMode createMode)</div><div class="line">    <span class="keyword">throws</span> KeeperException, InterruptedException</div><div class="line">&#123;</div><div class="line">    <span class="keyword">final</span> String clientPath = path;</div><div class="line">    PathUtils.validatePath(clientPath, createMode.isSequential());</div><div class="line"></div><div class="line">    <span class="keyword">final</span> String serverPath = prependChroot(clientPath);</div><div class="line"></div><div class="line">    RequestHeader h = <span class="keyword">new</span> RequestHeader();</div><div class="line">    h.setType(ZooDefs.OpCode.create);</div><div class="line">    CreateRequest request = <span class="keyword">new</span> CreateRequest();</div><div class="line">    CreateResponse response = <span class="keyword">new</span> CreateResponse();</div><div class="line">    request.setData(data);</div><div class="line">    </div><div class="line">    <span class="comment">/////////////////////////////////</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">    * You can see here that ZooKeeper client set </div><div class="line">    * the `CreateMode` flag for the request</div><div class="line">    */</div><div class="line">    request.setFlags(createMode.toFlag());</div><div class="line">    <span class="comment">/////////////////////////////////</span></div><div class="line">    </div><div class="line">    request.setPath(serverPath);</div><div class="line">    <span class="keyword">if</span> (acl != <span class="keyword">null</span> &amp;&amp; acl.size() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException();</div><div class="line">    &#125;</div><div class="line">    request.setAcl(acl);</div><div class="line">    </div><div class="line">    <span class="comment">///////// then send the request to ZooKeeper server /////////</span></div><div class="line">    ReplyHeader r = cnxn.submitRequest(h, request, response, <span class="keyword">null</span>);</div><div class="line">    <span class="comment">/////////////////////////////////</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (r.getErr() != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> KeeperException.create(KeeperException.Code.get(r.getErr()),</div><div class="line">                clientPath);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cnxn.chrootPath == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> response.getPath();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> response.getPath().substring(cnxn.chrootPath.length());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="The-Server-Side"><a href="#The-Server-Side" class="headerlink" title="The Server Side"></a>The Server Side</h2><h3 id="1-PrepRequestProcessor-java"><a href="#1-PrepRequestProcessor-java" class="headerlink" title="1. PrepRequestProcessor.java"></a>1. <code>PrepRequestProcessor.java</code></h3><p><a href="http://grepcode.com/file/repo1.maven.org/maven2/org.apache.zookeeper/zookeeper/3.4.6/org/apache/zookeeper/server/PrepRequestProcessor.java?av=f" target="_blank" rel="external">org.apache.zooekeeper.server.PrepRequestProcessor.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This method will be called inside the ProcessRequestThread, which is a singleton, so there will be a single thread calling this code.</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span></span></div><div class="line">    <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException</div><div class="line">&#123;</div><div class="line">    request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</div><div class="line">                                zks.getTime(), type);</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (type) &#123;</div><div class="line">        <span class="comment">//////// --- the beginning --- ////////</span></div><div class="line">        <span class="comment">//////// if this request is to create node  ///////// </span></div><div class="line">        <span class="keyword">case</span> OpCode.create:</div><div class="line">        </div><div class="line">            zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">            CreateRequest createRequest = (CreateRequest)record;   </div><div class="line">            <span class="keyword">if</span>(deserialize)</div><div class="line">                ByteBufferInputStream.byteBuffer2Record(request.request, createRequest);</div><div class="line">            String path = createRequest.getPath();</div><div class="line">            <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">            <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span> || failCreate) &#123;</div><div class="line">                LOG.info(<span class="string">"Invalid path "</span> + path + <span class="string">" with session 0x"</span> +</div><div class="line">                        Long.toHexString(request.sessionId));</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">            &#125;</div><div class="line">            List&lt;ACL&gt; listACL = removeDuplicates(createRequest.getAcl());</div><div class="line">            <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//////// get parent node's ChangeRecord  /////////</span></div><div class="line">            String parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">            ChangeRecord parentRecord = getRecordForPath(parentPath); <span class="comment">// See implementation below</span></div><div class="line"></div><div class="line">            checkACL(zks, parentRecord.acl, ZooDefs.Perms.CREATE,</div><div class="line">                    request.authInfo);</div><div class="line">            </div><div class="line">            <span class="comment">//////// get cversion of parent's ChangeRecord ////////</span></div><div class="line">            <span class="keyword">int</span> parentCVersion = parentRecord.stat.getCversion();</div><div class="line">            </div><div class="line">            </div><div class="line">            <span class="comment">//////// get the CreateMode flag from request ////////</span></div><div class="line">            CreateMode createMode =</div><div class="line">                CreateMode.fromFlag(createRequest.getFlags());</div><div class="line">            </div><div class="line">            <span class="comment">//////// create sequential node path ////////</span></div><div class="line">            <span class="keyword">if</span> (createMode.isSequential()) &#123;</div><div class="line">                path = path + String.format(Locale.ENGLISH, <span class="string">"%010d"</span>, parentCVersion);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                PathUtils.validatePath(path);</div><div class="line">            &#125; <span class="keyword">catch</span>(IllegalArgumentException ie) &#123;</div><div class="line">                LOG.info(<span class="string">"Invalid path "</span> + path + <span class="string">" with session 0x"</span> +</div><div class="line">                        Long.toHexString(request.sessionId));</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//////// check if node exists ////////</span></div><div class="line">                <span class="keyword">if</span> (getRecordForPath(path) != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NodeExistsException(path);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</div><div class="line">                <span class="comment">// ignore this one</span></div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//////// ensure parent is a persistent node ////////</span></div><div class="line">            <span class="keyword">boolean</span> ephemeralParent = parentRecord.stat.getEphemeralOwner() != <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> (ephemeralParent) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoChildrenForEphemeralsException(path);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//////// increase cversion of parent's ChangeRecord by 1 ////////</span></div><div class="line">            <span class="keyword">int</span> newCversion = parentRecord.stat.getCversion()+<span class="number">1</span>;</div><div class="line">            request.txn = <span class="keyword">new</span> CreateTxn(path, createRequest.getData(),</div><div class="line">                    listACL,</div><div class="line">                    createMode.isEphemeral(), newCversion);</div><div class="line">            StatPersisted s = <span class="keyword">new</span> StatPersisted();</div><div class="line">            <span class="keyword">if</span> (createMode.isEphemeral()) &#123;</div><div class="line">                s.setEphemeralOwner(request.sessionId);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//////// set parent's ChangeRecord ////////</span></div><div class="line">            parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">            parentRecord.childCount++;</div><div class="line">            parentRecord.stat.setCversion(newCversion);</div><div class="line">            addChangeRecord(parentRecord);</div><div class="line">            addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path, s,</div><div class="line">                    <span class="number">0</span>, listACL));</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">//////// --- the end --- ////////</span></div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="keyword">case</span> OpCode.delete:</div><div class="line">            ...</div><div class="line">        <span class="keyword">case</span> OpCode.setData:</div><div class="line">            ...</div><div class="line">        <span class="keyword">case</span> OpCode.setACL:</div><div class="line">            ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function">ChangeRecord <span class="title">getRecordForPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> KeeperException.NoNodeException </span>&#123;</div><div class="line">        ChangeRecord lastChange = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">synchronized</span> (zks.outstandingChanges) &#123;</div><div class="line">            <span class="comment">/////// zks is an Object of `ZooKeeperServer.java` ///////</span></div><div class="line">            lastChange = zks.outstandingChangesForPath.get(path);</div><div class="line">            <span class="comment">/*</span></div><div class="line">            for (int i = 0; i &lt; zks.outstandingChanges.size(); i++) &#123;</div><div class="line">                ChangeRecord c = zks.outstandingChanges.get(i);</div><div class="line">                if (c.path.equals(path)) &#123;</div><div class="line">                    lastChange = c;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            */</div><div class="line">            <span class="comment">//////// if this is a new node, create its ChangeRecord ////////</span></div><div class="line">            <span class="keyword">if</span> (lastChange == <span class="keyword">null</span>) &#123;</div><div class="line">                DataNode n = zks.getZKDatabase().getNode(path);</div><div class="line">                <span class="keyword">if</span> (n != <span class="keyword">null</span>) &#123;</div><div class="line">                    Long acl;</div><div class="line">                    Set&lt;String&gt; children;</div><div class="line">                    <span class="keyword">synchronized</span>(n) &#123;</div><div class="line">                        acl = n.acl;</div><div class="line">                        children = n.getChildren();</div><div class="line">                    &#125;</div><div class="line">                    lastChange = <span class="keyword">new</span> ChangeRecord(-<span class="number">1</span>, path, n.stat,</div><div class="line">                        children != <span class="keyword">null</span> ? children.size() : <span class="number">0</span>,</div><div class="line">                            zks.getZKDatabase().convertLong(acl));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (lastChange == <span class="keyword">null</span> || lastChange.stat == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException(path);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//////// return the ChangeRecord ////////</span></div><div class="line">        <span class="keyword">return</span> lastChange;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="2-ZooKeeperServer-java-and-ChangeRecord-java"><a href="#2-ZooKeeperServer-java-and-ChangeRecord-java" class="headerlink" title="2. ZooKeeperServer.java and ChangeRecord.java"></a>2. <code>ZooKeeperServer.java</code> and <code>ChangeRecord.java</code></h3><p><a href="http://grepcode.com/file/repo1.maven.org/maven2/org.apache.zookeeper/zookeeper/3.4.6/org/apache/zookeeper/server/ZooKeeperServer.java" target="_blank" rel="external">org.apache.zookeeper.server.ZooKeeperServer.java</a></p>
<pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">More</span> ...<span class="title">ZooKeeperServer</span> <span class="keyword">implements</span> <span class="title">SessionExpirer</span>, <span class="title">ServerStats</span>.<span class="title">Provider</span> </span>{
    ...

    <span class="keyword">final</span> List&lt;ChangeRecord&gt; outstandingChanges = <span class="keyword">new</span> ArrayList&lt;ChangeRecord&gt;();
    <span class="comment">// this data structure must be accessed under the outstandingChanges lock</span>

    <span class="comment">//////// a hashmap that maps &lt;path, path's ChangeRecord&gt; ////////</span>
    <span class="keyword">final</span> HashMap&lt;String, ChangeRecord&gt; outstandingChangesForPath =
    <span class="keyword">new</span> HashMap&lt;String, ChangeRecord&gt;();

    ...

    <span class="comment">/**
     * This structure is used to facilitate information sharing between PrepRP
     * and FinalRP.
     */</span>
    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeRecord</span> </span>{
        ChangeRecord(<span class="keyword">long</span> zxid, String path, StatPersisted stat, <span class="keyword">int</span> childCount,
                List&lt;ACL&gt; acl) {
            <span class="keyword">this</span>.zxid = zxid;
            <span class="keyword">this</span>.path = path;
            <span class="keyword">this</span>.stat = stat;
            <span class="keyword">this</span>.childCount = childCount;
            <span class="keyword">this</span>.acl = acl;
        }

        <span class="keyword">long</span> zxid;

        String path;

        StatPersisted stat; <span class="comment">/* Make sure to create a new object when changing */</span>

        <span class="keyword">int</span> childCount;

        List&lt;ACL&gt; acl; <span class="comment">/* Make sure to create a new object when changing */</span>

        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)
        <span class="function">ChangeRecord <span class="title">duplicate</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>{
            StatPersisted stat = <span class="keyword">new</span> StatPersisted();
            <span class="keyword">if</span> (<span class="keyword">this</span>.stat != <span class="keyword">null</span>) {
                DataTree.copyStatPersisted(<span class="keyword">this</span>.stat, stat);
            }
            <span class="keyword">return</span> <span class="keyword">new</span> ChangeRecord(zxid, path, stat, childCount,
                    acl == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;ACL&gt;() : <span class="keyword">new</span> ArrayList(acl));
        }
    }
}
</code></pre>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/zookeeper/" rel="tag">#zookeeper</a>
          
            <a href="/tags/zookeeper-persistent-sequential-id/" rel="tag">#zookeeper persistent sequential id</a>
          
            <a href="/tags/create-mode-persistent-sequential/" rel="tag">#create mode persistent sequential</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/04/distributed system/zookeeper/ZooKeeper-Consistency-Guarantees/" rel="next" title="ZooKeeper - Consistency Guarantees">
                <i class="fa fa-chevron-left"></i> ZooKeeper - Consistency Guarantees
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/08/ruby/Ruby-Ruby-blocks-and-yield-statement/" rel="prev" title="Ruby - Ruby blocks and yield statement">
                Ruby - Ruby blocks and yield statement <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/avatar/avatar.jpg"
               alt="Bowen" />
          <p class="site-author-name" itemprop="name">Bowen</p>
          <p class="site-description motion-element" itemprop="description">keep learning - learning notes and blogs</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="https://phoenixjiangnan.github.io/archives">
              <span class="site-state-item-count">105</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="https://phoenixjiangnan.github.io/categories">
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="https://phoenixjiangnan.github.io/tags">
                <span class="site-state-item-count">250</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#The-Start"><span class="nav-number">1.</span> <span class="nav-text">The Start</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-Principle"><span class="nav-number">2.</span> <span class="nav-text">The Principle</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Source-Code-Analysis"><span class="nav-number">3.</span> <span class="nav-text">Source Code Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Client-ZooKeeper-java"><span class="nav-number">3.1.</span> <span class="nav-text">The Client - ZooKeeper.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Server-Side"><span class="nav-number">3.2.</span> <span class="nav-text">The Server Side</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-PrepRequestProcessor-java"><span class="nav-number">3.2.1.</span> <span class="nav-text">1. PrepRequestProcessor.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ZooKeeperServer-java-and-ChangeRecord-java"><span class="nav-number">3.2.2.</span> <span class="nav-text">2. ZooKeeperServer.java and ChangeRecord.java</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bowen</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'bowensgithubblog';
      var disqus_identifier = '2016/07/07/distributed system/zookeeper/How-does-ZooKeeper-s-persistent-sequential-id-work/';
      var disqus_title = "How does ZooKeeper\'s persistent sequential id work";
      var disqus_url = 'https://phoenixjiangnan.github.io/2016/07/07/distributed system/zookeeper/How-does-ZooKeeper-s-persistent-sequential-id-work/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

</body>
</html>
